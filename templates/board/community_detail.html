{% extends "board/community_list.html" %}
{% block detail %}
<script src="https://code.jquery.com/jquery-3.5.1.js" integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc="
    crossorigin="anonymous"></script>
<script>
    function like(id) {
        $.ajax({
            url: "{% url 'board:like' %}",
            data: {
                board_id: id,
            },
            dataType: "json",
            success: function (response) {
                $("#like_count").html(response.like);
                if (response.message == "off") {
                    $("#like").attr("class", "fa-regular fa-thumbs-up");
                } else if (response.message == "on") {
                    $("#like").attr("class", "fa-solid fa-thumbs-up");
                } else if (response.message == "notlogin") {
                    alert("로그인이 필요한 기능입니다.")
                }
            },
        });
    }
    $(document).ready(function () {
        $('#comment_create').click(function () {
            if ($('#comment_content').val() == "") { alert('댓글을 입력해주세요.'); }
            else
                $.ajax({
                    type: "POST",
                    url: "{% url 'board:comment_create' board.id %}",
                    dataType: "json",
                    data: {
                        'writer': $("#comment_writer").val(),
                        'content': $("#comment_content").val(),
                        'csrfmiddlewaretoken': '{{csrf_token}}',
                    },
                    success: function (response) {
                        {
                            $('#new_comment').append(
                                "<li id='" + response.comment_id + "'style='border-top:1px solid #848b79; border-bottom:1px solid #848b79;'>" +
                                "<img id='profile-img'><div>" + response.writer +
                                "<span><a onclick='commentUpdate(" + response.comment_id + ")'>수정</a>" +
                                " <a onclick='commentDelete(" + response.comment_id + ")'>삭제</a></span>" +
                                "<p id=" + response.comment_id + "content>" + response.content + "</p></div></li>"
                            );
                        }
                        $("#comment_count").html(response.comment_count + "개");
                        $('#comment_content').val("");
                    },
                })
        });
    });
    function boardDelete() {
        var warning = confirm("게시글을 삭제할 경우 복구가 불가능합니다.\n정말 삭제하시겠습니까?");
        if (warning == true) {
            window.location.href = "{% url 'board:community_delete' board.id %}"
        }
    }
    function notlogin() {
        alert("로그인이 필요한 기능입니다.")
    }

    function commentDelete(value) {
        var delete_warning = confirm("댓글을 삭제할 경우 복구가 불가능합니다.\n정말 삭제하시겠습니까?");
        if (delete_warning == true) {
            $.ajax({
                type: "POST",
                url: "{% url 'board:comment_delete' board.id %}",
                dataType: "json",
                data: {
                    comment_id: value,
                    csrfmiddlewaretoken: "{{csrf_token}}",
                },
                success: function (response) {
                    $("#" + value).remove();
                    $("#comment_count").html(response.comment_count + "개");
                },
            });
        }
    }

    function commentUpdate(value) {
        $.ajax({
            type: "POST",
            url: "{% url 'board:comment_update' board.id %}",
            dataType: "json",
            data: {
                comment_id: value,
                content: $("#comment_content").val(),
                csrfmiddlewaretoken: "{{csrf_token}}",
            },
            success: function (response) {
                $("#" + value + "content").html("<textarea id='edit_comment'>" + response.content + "</textarea>" +
                    "<button id='cancel'>취소</button> <button id='done'>수정</button>")
                $("#cancel").click(function () {
                    $("#" + value + "content").replaceWith("<p id='" + value + "content'>" + response.content + "</p>");
                });
                $("#done").click(function () {
                    if ($("#edit_comment").val() == "") { alert('댓글을 입력해주세요.'); }
                    else
                        $.ajax({
                            type: "POST",
                            url: "{% url 'board:comment_update' board.id %}",
                            dataType: "json",
                            data: {
                                comment_id: value,
                                edit_comment: $("#edit_comment").val(),
                                csrfmiddlewaretoken: "{{csrf_token}}",
                            },
                            success: function (response) {
                                $("#" + value + "content").replaceWith("<p id='" + value + "content'>" + response.edit_comment + "</p>");
                            },
                        });
                });
            }
        });
    }
    $(function () {
        $('.title li').click(function () {
            $('.title li').removeClass('on');
            $('.tabcont').removeClass('on');
            $(this).addClass('on');
            $('#' + $(this).attr('data-tab')).addClass('on');
            $('.title li').css('color', '#aaa');
            $(this).css('color', '#eee');
        })
    });
</script>
<section id="detail">
    {{ board.title }}
    {% if request.user == board.writer %}
    <span class="modify">
        <a href="{% url 'board:community_update' board.id %}">수정</a>
        <a onclick="boardDelete('{{board.id}}')" id="del">삭제</a>
    </span>
    {% endif %}
    <div class="sub">
        {{ board.writer }} |
        <i class="fa-solid fa-eye"></i> {{ board.view }}
        <i class="fa-solid fa-thumbs-up"></i> {{ board.like }}
        <i class="fa-solid fa-comment-dots"></i> {{ board.comment_set.count }}
        <span><i class="fa-solid fa-clock"></i> {{ board.date }}</span>
    </div>
    <div class="content">
        {{ board.content | safe }}
    </div>
    <div class="writer-info">
        <div class="info">
            {% if board.writer.image %}
            <img src="{{ board.writer.image.url }}">
            {% else %}
            <img src="https://i.stack.imgur.com/34AD2.jpg">
            {% endif %}
            <span>
                <p><a href="{% url 'user:profile' board.writer.id %}">{{ board.writer }}</a></p>
                <p>{{ board.writer.point }} 포인트</p>
                <p>{{ board.writer.join_date }}</p>
            </span>
        </div>
        <div>
            <ul class="title">
                <li data-tab="board" class='on'>최근 작성한 글</li>
                <li data-tab="comment" style="color:#aaa;">최근 작성한 댓글</li>
            </ul>
            <ul id="board" class="tabcont on">
                {% for list in board.writer.community_set.all|slice:"5" %}
                <li><a href="{% url 'board:community_detail' board.id %}">{{ list.title }}</a></li>
                {% endfor %}
            </ul>
            <ul id="comment" class="tabcont">
                {% for list in board.writer.comment_set.all|slice:"5" %}
                <li>{{ list.content }}</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <div class="buttons">
        <button id="{{ board.id }}" onclick="like(this.id)">
            {% if request.user in board.like_users.all %}
            <i id="like" class="fa-solid fa-thumbs-up"></i> 추천 <span id="like_count">{{board.like}}</span>
            {% else %}
            <i id="like" class="fa-regular fa-thumbs-up"></i> 추천 <span id="like_count">{{board.like}}</span>
            {% endif %}
        </button>
        <button id="flag"><i class="fa-solid fa-flag"></i> 신고</button>
    </div>
    <img id="detail-ad">
    {% if request.user.is_authenticated %}
    <textarea id="comment_content" name="content" rows="4" placeholder="댓글을 입력하세요."></textarea>
    <button id="comment_create">등록</button>
    <input type="hidden" id="comment_writer" value={{request.user}}>
    {% else %}
    <textarea id="comment_content" rows="4" placeholder="댓글을 입력하세요." onclick="notlogin()"></textarea>
    {% endif %}
    <i class="fa-solid fa-comment-dots" style="color:#eee;"></i>
    <span id="comment_count">{{board.comment_set.count}}개</span>
    <ul id="new_comment"></ul>
    <ul id="comment_list">
        {% for comment in board.comment_set.all %}
        <li id="{{comment.id}}">
            {% if request.user.image %}
            <img src="{{ request.user.image.url }}">
            {% else %}
            <img src="https://i.stack.imgur.com/34AD2.jpg">
            {% endif %}
            <div>
                {{comment.writer}}
                <span>
                    {% if request.user == comment.writer %}
                    <a onclick="commentUpdate('{{comment.id}}')">수정</a>
                    <a onclick="commentDelete('{{comment.id}}')">삭제</a>
                    {% endif %}
                    <i class="fa-solid fa-clock"></i> {{comment.date}}
                </span>
                <p id="{{comment.id}}content">{{comment.content}}</p>
            </div>
        </li>
        {% endfor %}
    </ul>
</section>
{% endblock detail %}